<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Мониторинг торгового бота</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- Roboto Flex - основной шрифт -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Flex:opsz,wght@8..144,100;8..144,200;8..144,300;8..144,400;8..144,500;8..144,600;8..144,700;8..144,800;8..144,900&display=swap" rel="stylesheet">
  <!-- Inter - альтернативный шрифт для лучшей читаемости -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <!-- JetBrains Mono - моноширинный шрифт для чисел и кода -->
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@100;200;300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- UI libs (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  
  <!-- Lucide Icons - современные SVG иконки -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <!-- App styles (модульная структура, порядок критичен) -->
  <link rel="stylesheet" href="styles_variables.css">
  <link rel="stylesheet" href="styles_typography.css">
  <link rel="stylesheet" href="styles_layout.css">
  <link rel="stylesheet" href="styles_forms.css">
  <link rel="stylesheet" href="styles_components.css">
  <link rel="stylesheet" href="styles_kpi.css">
  <link rel="stylesheet" href="styles_plot.css">
  <link rel="stylesheet" href="styles_states.css">
  <link rel="stylesheet" href="styles_icons.css">
  <link rel="stylesheet" href="styles_fonts.css">

  <!-- Charts + libs -->
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- App scripts (split) -->
  <script defer src="app_core.js"></script>
  <script defer src="app_theme.js"></script>
  <script defer src="app_ui.js"></script>
  <script defer src="app_state.js"></script>
  <script defer src="app_chart.js"></script>
  <script defer src="app_logs.js"></script>
  <script defer src="app_csv.js"></script>
  <script defer src="app_init.js"></script>
  <script defer src="app_kpi.js"></script>
</head>
<body class="cyrillic-text">
  <!-- Содержимое страницы без изменений -->
  <nav class="navbar navbar-expand-lg navbar-dark px-3">
    <div class="d-flex align-items-center gap-2">
      <a class="navbar-brand d-flex align-items-center" href="#">
        <i data-lucide="bot" class="navbar-brand-icon"></i>
        Мониторинг бота
      </a>
      <!-- Пилюля статуса -->
      <div class="status-pill" id="statusPill" title="Состояние API" data-bs-toggle="tooltip">
        <span class="status-dot status-warn" id="statusDot"></span>
        <span id="statusText">offline</span>
      </div>
    </div>
    <div class="ms-auto d-flex align-items-center gap-2">
      <div class="form-check form-switch text-nowrap" title="Переключить тему" data-bs-toggle="tooltip">
        <input class="form-check-input" type="checkbox" id="themeToggle">
        <label class="form-check-label" for="themeToggle">
          <i data-lucide="moon" class="theme-icon"></i>
          Тема
        </label>
      </div>
      <button id="refreshAll" class="btn btn-sm btn-outline-light" title="Обновить все панели" data-bs-toggle="tooltip">
        <i data-lucide="refresh-cw" class="btn-icon"></i>
        Обновить всё
      </button>
    </div>
  </nav>

  <div id="topProgress"></div>

  <div id="snackbar" style="position:fixed;left:50%;transform:translateX(-50%);bottom:16px;z-index:2000;display:none;max-width:90%;">
    <div class="card p-2" style="background:var(--surface);box-shadow:var(--elev-2);">
      <span id="snackbarMsg"></span>
    </div>
  </div>

  <div class="content container-fluid">
    <!-- KPI -->
    <div class="row g-3 mb-3">
      <div class="col-12 col-sm-6 col-xl-3">
        <div class="card p-3 kpi kpi-balance" data-kpi-type="balance">
          <div class="kpi-header">
            <div class="kpi-icon">
              <i data-lucide="wallet" class="kpi-icon-svg"></i>
            </div>
            <div class="kpi-sub">Баланс</div>
          </div>
          <div class="kpi-value" id="kpi-balance">
            <span class="skeleton lg"></span>
          </div>
          <div class="kpi-footer">
            <span class="text-muted" id="kpi-balance-cur">USDT</span>
            <div class="kpi-trend" id="kpi-balance-trend"></div>
          </div>
        </div>
      </div>
      
      <div class="col-12 col-sm-6 col-xl-3">
        <div class="card p-3 kpi kpi-positions" data-kpi-type="positions">
          <div class="kpi-header">
            <div class="kpi-icon">
              <i data-lucide="trending-up" class="kpi-icon-svg"></i>
            </div>
            <div class="kpi-sub">Позиции</div>
          </div>
          <div class="kpi-value" id="kpi-positions">
            <span class="skeleton lg"></span>
          </div>
          <div class="kpi-footer">
            <span class="text-muted">Открытые позиции</span>
            <div class="kpi-badge" id="kpi-positions-badge"></div>
          </div>
        </div>
      </div>
      
      <div class="col-12 col-sm-6 col-xl-3">
        <div class="card p-3 kpi kpi-updated" data-kpi-type="updated">
          <div class="kpi-header">
            <div class="kpi-icon">
              <i data-lucide="clock" class="kpi-icon-svg"></i>
            </div>
            <div class="kpi-sub">Последнее обновление</div>
          </div>
          <div class="kpi-value" id="kpi-updated">
            <span class="skeleton lg"></span>
          </div>
          <div class="kpi-footer">
            <span class="text-muted">state.json</span>
            <div class="kpi-status" id="kpi-updated-status"></div>
          </div>
        </div>
      </div>
      
      <div class="col-12 col-sm-6 col-xl-3">
        <div class="card p-3 kpi kpi-file" data-kpi-type="file">
          <div class="kpi-header">
            <div class="kpi-icon">
              <i data-lucide="bar-chart-3" class="kpi-icon-svg"></i>
            </div>
            <div class="kpi-sub">Файл данных</div>
          </div>
          <div class="kpi-value file-name" id="kpi-file">
            <span class="skeleton lg"></span>
          </div>
          <div class="kpi-footer">
            <span class="text-muted">источник графика</span>
            <div class="kpi-indicator" id="kpi-file-indicator"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs" id="viewTabs" role="tablist" style="position:relative;">
      <li class="nav-item"><button class="nav-link active" id="chart-tab" data-bs-toggle="tab" data-bs-target="#chart-pane" type="button"><i data-lucide="line-chart" class="tab-icon"></i> График цен</button></li>
      <li class="nav-item"><button class="nav-link" id="csv-tab" data-bs-toggle="tab" data-bs-target="#csv-pane" type="button"><i data-lucide="table" class="tab-icon"></i> CSV данные</button></li>
      <li class="nav-item"><button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs-pane" type="button"><i data-lucide="file-text" class="tab-icon"></i> Логи</button></li>
      <li class="nav-item"><button class="nav-link" id="logs-all-tab" data-bs-toggle="tab" data-bs-target="#logs-all-pane" type="button"><i data-lucide="files" class="tab-icon"></i> Все логи</button></li>
      <li class="nav-item"><button class="nav-link" id="state-tab" data-bs-toggle="tab" data-bs-target="#state-pane" type="button"><i data-lucide="wallet" class="tab-icon"></i> Баланс и позиции</button></li>
      <span id="tabsInk" class="tabs-ink"></span>
    </ul>

    <div class="tab-content mt-3">
      <!-- Chart -->
      <div class="tab-pane fade show active" id="chart-pane">
        <div class="card p-3 mb-3">
          <div class="toolbar">
            <div class="group">
              <label class="form-label">CSV‑файл</label>
              <select id="csvFile" class="form-select form-select-sm field-outlined" title="Файл данных для графика" data-bs-toggle="tooltip"></select>
            </div>
            <div class="group narrow">
              <label class="form-label">Хвост (строк)</label>
              <input id="tailRows" type="number" min="50" step="50" value="500" class="form-control form-control-sm field-outlined" title="Сколько последних строк загрузить" data-bs-toggle="tooltip"/>
            </div>
            <div class="group">
              <label class="form-label">Быстрый хвост</label>
              <div id="tailSegments" class="btn-group btn-group-sm" role="group" title="Быстрый выбор размера хвоста" data-bs-toggle="tooltip">
                <button class="btn btn-outline-light active" data-tail="200">200</button>
                <button class="btn btn-outline-light" data-tail="500">500</button>
                <button class="btn btn-outline-light" data-tail="1000">1000</button>
              </div>
            </div>
            <div class="group narrow">
              <label class="form-label">Панель 2</label>
              <select id="lowerPanel" class="form-select form-select-sm field-outlined" title="Что показывать в нижней панели" data-bs-toggle="tooltip">
                <option value="rsi" selected>RSI</option>
                <option value="volume">Объём</option>
              </select>
            </div>
            <div id="rsiControls" class="group narrow" style="display:none;">
              <label class="form-label">RSI период</label>
              <input id="rsiPeriod" type="number" min="2" step="1" value="14" class="form-control form-control-sm field-outlined" title="Период RSI" data-bs-toggle="tooltip"/>
            </div>
            <div class="group" style="min-width:280px;">
              <label class="form-label">Показывать</label>
              <div class="chips">
                <div class="chip" id="chipSMA20" data-bind="#sma20" title="Включить/выключить SMA 20" data-bs-toggle="tooltip"><i data-lucide="activity" class="chip-icon"></i> SMA 20</div>
                <div class="chip" id="chipSMA50" data-bind="#sma50" title="Включить/выключить SMA 50" data-bs-toggle="tooltip"><i data-lucide="activity" class="chip-icon"></i> SMA 50</div>
                <div class="chip selected" id="chipSigRSI" data-bind="#signals_rsi" title="RSI" data-bs-toggle="tooltip"><i data-lucide="zap" class="chip-icon"></i> RSI</div>
                <div class="chip selected" id="chipSigXGB" data-bind="#signals_xgb" title="XGB" data-bs-toggle="tooltip"><i data-lucide="bot" class="chip-icon"></i> XGB</div>
              </div>
            </div>
            <div class="ms-auto">
              <div class="d-flex gap-2">
                <button id="resetZoom" class="btn btn-outline-light btn-sm" title="Сбросить масштаб графика" data-bs-toggle="tooltip">
                  <i data-lucide="maximize-2" class="btn-icon"></i>
                  Сброс масштаба
                </button>
                <button class="btn btn-outline-light btn-sm" data-bs-toggle="offcanvas" data-bs-target="#advancedSheet" title="Доп. параметры" data-bs-toggle2="tooltip">
                  <i data-lucide="sliders" class="btn-icon"></i>
                  Параметры
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="card p-2 chart-actions">
          <div id="chart">
            <div id="chartLoader" class="loading-overlay" style="display:none;">
              <div class="spinner-border text-light" role="status"><span class="visually-hidden">Загрузка…</span></div>
            </div>
          </div>
          <button id="reloadChart" class="fab" title="Перестроить график" data-bs-toggle="tooltip">
            <span class="fab-ico-wrap">
              <span class="fab-ring" aria-hidden="true">
                <svg viewBox="0 0 40 40">
                  <circle class="ring-bg" cx="20" cy="20" r="16"></circle>
                  <circle id="fabRing" class="ring" cx="20" cy="20" r="16" stroke-dasharray="100" stroke-dashoffset="100"></circle>
                </svg>
              </span>
              <i data-lucide="refresh-cw" class="fab-icon"></i>
            </span>
          </button>
        </div>
      </div>

      <!-- CSV preview -->
      <div class="tab-pane fade" id="csv-pane">
        <div class="card p-3 mb-3">
          <div class="toolbar">
            <div class="group narrow">
              <label class="form-label">Показать последние (строк)</label>
              <input id="csvViewTail" type="number" min="50" step="50" value="300" class="form-control form-control-sm field-outlined"/>
            </div>
            <div class="ms-auto d-flex gap-2">
              <button class="btn btn-outline-light btn-sm" id="csvReload">
                <i data-lucide="refresh-cw" class="btn-icon"></i>
                Обновить
              </button>
              <button class="btn btn-outline-light btn-sm" id="csvDownload">
                <i data-lucide="download" class="btn-icon"></i>
                Скачать как CSV
              </button>
            </div>
          </div>
        </div>
        <div class="card p-2 position-relative">
          <div id="csvLoader" class="loading-overlay" style="display:none;">
            <div class="spinner-border text-light" role="status"><span class="visually-hidden">Загрузка…</span></div>
          </div>
          <div style="max-height:520px; overflow:auto;">
            <table class="table-md3" id="csvTable">
              <thead id="csvThead"></thead>
              <tbody id="csvTbody"><tr><td><span class="skeleton" style="height:24px;display:block"></span></td></tr></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Logs by file -->
      <div class="tab-pane fade" id="logs-pane">
        <div class="card p-3 mb-3">
          <div class="toolbar">
            <div class="group"><label class="form-label">Файл логов</label><select id="logFile" class="form-select form-select-sm field-outlined"></select></div>
            <div class="group narrow"><label class="form-label">Хвост (строк)</label><input id="logTail" type="number" min="100" step="100" value="500" class="form-control form-control-sm field-outlined"/></div>
            <div class="ms-auto">
              <button class="btn btn-outline-light btn-sm" id="reloadLogs" title="Обновить лог" data-bs-toggle="tooltip">
                <i data-lucide="refresh-cw" class="btn-icon"></i>
                Обновить
              </button>
              <button class="btn btn-outline-light btn-sm" data-bs-toggle="offcanvas" data-bs-target="#logsSheet" title="Доп. параметры" data-bs-toggle2="tooltip">
                <i data-lucide="sliders" class="btn-icon"></i>
                Параметры
              </button>
            </div>
          </div>
        </div>
        <div class="card p-2 position-relative">
          <div id="logLoader" class="loading-overlay" style="display:none;">
            <div class="spinner-border text-light" role="status"><span class="visually-hidden">Загрузка…</span></div>
          </div>
          <div class="log-box" id="logBox"><div class="empty">
            <svg viewBox="0 0 120 120" aria-hidden="true">
              <defs>
                <linearGradient id="g1" x1="0" x2="1" y1="0" y2="1">
                  <stop offset="0%"  stop-color="#6E46FF"/>
                  <stop offset="100%" stop-color="#20C9C3"/>
                </linearGradient>
              </defs>
              <circle cx="60" cy="60" r="46" fill="url(#g1)">
                <animate attributeName="r" values="42;46;42" dur="3s" repeatCount="indefinite"/>
              </circle>
              <circle cx="60" cy="60" r="26" fill="rgba(255,255,255,.18)"/>
            </svg>
            <div class="title">Нет данных</div>
            <div class="sub">Здесь появится хвост логов</div>
          </div></div>
        </div>
      </div>

      <!-- Logs all -->
      <div class="tab-pane fade" id="logs-all-pane">
        <div class="card p-3 mb-3">
          <div class="toolbar">
            <div id="logLevelButtons" class="btn-group" role="group" aria-label="levels">
              <button class="btn btn-outline-light btn-sm btn-filter active" data-level="ALL">ALL</button>
              <button class="btn btn-outline-light btn-sm btn-filter" data-level="INFO">INFO</button>
              <button class="btn btn-outline-light btn-sm btn-filter" data-level="WARN">WARN</button>
              <button class="btn btn-outline-light btn-sm btn-filter" data-level="ERROR">ERROR</button>
              <button class="btn btn-outline-light btn-sm btn-filter" data-level="DEBUG">DEBUG</button>
            </div>
            <div class="group"><label class="form-label">Поиск</label><input id="logsAllQuery" class="form-control form-control-sm field-outlined" placeholder="текст…"/></div>
            <div class="group narrow"><label class="form-label">Последние N</label><input id="logsAllN" type="number" min="100" step="100" value="1000" class="form-control form-control-sm field-outlined"/></div>
            <div class="ms-auto">
              <button class="btn btn-outline-light btn-sm" id="reloadLogsAll">
                <i data-lucide="refresh-cw" class="btn-icon"></i>
                Обновить
              </button>
              <button class="btn btn-outline-light btn-sm" data-bs-toggle="offcanvas" data-bs-target="#logsAllSheet">
                <i data-lucide="sliders" class="btn-icon"></i>
                Параметры
              </button>
            </div>
          </div>
        </div>
        <div class="card p-2 position-relative">
          <div id="logsAllLoader" class="loading-overlay" style="display:none;">
            <div class="spinner-border text-light" role="status"><span class="visually-hidden">Загрузка…</span></div>
          </div>
          <div class="log-box" id="logsAllBox"><div class="empty">
            <svg viewBox="0 0 120 120" aria-hidden="true">
              <defs>
                <linearGradient id="g2" x1="0" x2="1" y1="0" y2="1">
                  <stop offset="0%"  stop-color="#6E46FF"/>
                  <stop offset="100%" stop-color="#20C9C3"/>
                </linearGradient>
              </defs>
              <rect x="15" y="20" width="90" height="18" rx="9" fill="url(#g2)">
                <animate attributeName="width" values="70;90;70" dur="2.6s" repeatCount="indefinite"/>
              </rect>
              <rect x="25" y="48" width="70" height="18" rx="9" fill="rgba(255,255,255,.18)"/>
            </svg>
            <div class="title">Логи пусты</div>
            <div class="sub">Ожидаем события…</div>
          </div></div>
        </div>
      </div>

      <!-- State -->
      <div class="tab-pane fade" id="state-pane">
        <div class="row g-3">
          <div class="col-12 col-lg-6">
            <div class="card p-3"><h5 class="mb-3">Баланс</h5><div id="state-balance"><span class="skeleton lg" style="max-width:180px"></span></div></div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="card p-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">Позиции</h5>
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-light" id="posExport">
                    <i data-lucide="download" class="btn-icon"></i>
                    CSV
                  </button>
                  <button class="btn btn-outline-light" id="posRefresh" title="Обновить">
                    <i data-lucide="refresh-cw" class="btn-icon"></i>
                  </button>
                </div>
              </div>
              <div style="max-height:420px; overflow:auto;">
                <table class="table-md3" id="posTable">
                  <thead><tr>
                    <th>Тикер</th><th class="num">Кол-во</th><th class="num">Вход</th><th class="num">Цена</th><th class="num">PnL</th>
                  </tr></thead>
                  <tbody id="posTbody"><tr><td colspan="5"><span class="skeleton" style="height:24px;display:block"></span></td></tr></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div><!-- /state -->
    </div>
  </div>

  <!-- Bottom sheets -->
  <div class="offcanvas offcanvas-bottom text-bg-dark" tabindex="-1" id="advancedSheet" style="height:auto;">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title">
        <i data-lucide="sliders" class="offcanvas-icon"></i>
        Параметры графика
      </h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body small d-flex flex-wrap gap-3">
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="autoRefreshChart" checked>
        <label class="form-check-label" for="autoRefreshChart">Автообновление</label>
      </div>
      <div>
        <label class="form-label">Интервал (с)</label>
        <input id="chartInterval" type="number" min="5" step="5" value="10" class="form-control form-control-sm field-outlined"/>
      </div>
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="logScaleSwitch">
        <label class="form-check-label" for="logScaleSwitch">Логарифмический масштаб цены</label>
      </div>
    </div>
  </div>

  <div class="offcanvas offcanvas-bottom text-bg-dark" tabindex="-1" id="logsSheet" style="height:auto;">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title">
        <i data-lucide="sliders" class="offcanvas-icon"></i>
        Параметры логов
      </h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body small d-flex flex-wrap gap-3">
      <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="autoRefreshLogs"><label class="form-check-label" for="autoRefreshLogs">Автообновление</label></div>
      <div><label class="form-label">Интервал (с)</label><input id="logsInterval" type="number" min="5" step="5" value="15" class="form-control form-control-sm field-outlined"/></div>
    </div>
  </div>

  <div class="offcanvas offcanvas-bottom text-bg-dark" tabindex="-1" id="logsAllSheet" style="height:auto;">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title">
        <i data-lucide="sliders" class="offcanvas-icon"></i>
        Параметры «Все логи»
      </h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body small d-flex flex-wrap gap-3">
      <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="autoRefreshLogsAll"><label class="form-check-label" for="autoRefreshLogsAll">Автообновление</label></div>
      <div><label class="form-label">Интервал (с)</label><input id="logsAllInterval" type="number" min="5" step="5" value="15" class="form-control form-control-sm field-outlined"/></div>
    </div>
  </div>

  <!-- Инициализация Lucide иконок -->
  <script>
    // Инициализируем все Lucide иконки после загрузки страницы
    document.addEventListener('DOMContentLoaded', function() {
      lucide.createIcons();
    });
  </script>
</body>
</html>
