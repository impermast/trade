<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç–æ—Ä–≥–æ–≤–æ–≥–æ –±–æ—Ç–∞</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 20px; }
    .tab-content { margin-top: 20px; }
    .panel { border: 1px solid #ccc; padding: 10px; border-radius: 5px; background: #f9f9f9; }
    .log-box { height: 400px; overflow-y: scroll; white-space: pre-wrap; background: #1e1e1e; color: #dcdcdc; padding: 10px; font-family: monospace; }
  </style>
</head>
<body>
<div class="container">
  <h1 class="mb-4">üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç–æ—Ä–≥–æ–≤–æ–≥–æ –±–æ—Ç–∞</h1>
  <ul class="nav nav-tabs" id="myTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="chart-tab" data-bs-toggle="tab" data-bs-target="#chart" type="button" role="tab">–ì—Ä–∞—Ñ–∏–∫ —Ü–µ–Ω</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="trades-tab" data-bs-toggle="tab" data-bs-target="#trades" type="button" role="tab">–ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="state-tab" data-bs-toggle="tab" data-bs-target="#state" type="button" role="tab">–ë–∞–ª–∞–Ω—Å –∏ –ø–æ–∑–∏—Ü–∏–∏</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button" role="tab">–õ–æ–≥–∏</button>
    </li>
  </ul>
  <div class="tab-content">
    <div class="tab-pane fade show active" id="chart" role="tabpanel">
      <div class="mb-2">
        <label for="csvSelect" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–∞–Ω–Ω—ã—Ö:</label>
        <select id="csvSelect" class="form-select" style="max-width: 300px;"></select>
      </div>
      <img id="priceChart" src="" class="img-fluid border" style="width: 100%; max-height: 600px;">
      <a href="/candles" class="btn btn-outline-secondary mt-2">–°–∫–∞—á–∞—Ç—å CSV</a>
    </div>
    <div class="tab-pane fade" id="trades" role="tabpanel">
      <table class="table table-striped" id="tradeTable">
        <thead><tr><th>–î–∞—Ç–∞</th><th>–¢–∏–ø</th><th>–¶–µ–Ω–∞</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="tab-pane fade" id="state" role="tabpanel">
      <div class="panel" id="statePanel">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
    <div class="tab-pane fade" id="logs" role="tabpanel">
      <label for="logSelect" class="form-label mt-3">–í—ã–±–µ—Ä–∏—Ç–µ –ª–æ–≥-—Ñ–∞–π–ª:</label>
      <select class="form-select mb-3" id="logSelect"></select>
      <div class="log-box" id="logBox">–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤...</div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ —Ç–æ—á–µ–∫ —É –Ω–∞–¥–ø–∏—Å–∏ "–ó–∞–≥—Ä—É–∑–∫–∞"
function animateLoadingDots(elementId, baseText = "–ó–∞–≥—Ä—É–∑–∫–∞") {
    const el = document.getElementById(elementId);
    if (!el) return;
    let count = 0;
    setInterval(() => {
        count = (count + 1) % 4; // 0..3
        el.textContent = baseText + '.'.repeat(count);
    }, 500);
}

// –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
animateLoadingDots("statePanel", "–ó–∞–≥—Ä—É–∑–∫–∞");
</script>

<script>
function updateChart() {
  $.get("/candles", function(data) {
    const rows = data.trim().split("\n").slice(1);
    const time = [], close = [], marker_color = [], text = [];
    rows.forEach(r => {
      const cols = r.split(",");
      time.push(cols[0]);
      close.push(parseFloat(cols[4]));
      const order = parseInt(cols[6]);
      marker_color.push(order > 0 ? "green" : order < 0 ? "red" : "blue");
      text.push(order > 0 ? "–ö—É–ø–ª–µ–Ω–æ" : order < 0 ? "–ü—Ä–æ–¥–∞–Ω–æ" : "");
    });
    Plotly.newPlot("priceChart", [{
      x: time, y: close,
      type: 'scatter', mode: 'lines+markers',
      marker: { color: marker_color, size: 6 },
      text: text
    }], {title: '–¶–µ–Ω–∞ –∏ –æ—Ä–¥–µ—Ä–∞'});
  });
}

let selectedCsvFile = "BTCUSDT_1h_anal.csv";  // –Ω–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ

function updatePlotImage() {
  const img = document.getElementById("priceChart");
  img.src = `/plot?file=${selectedCsvFile}&ts=${new Date().getTime()}`;
}

function loadCsvList() {
  $.get("/csv_list", function(files) {
    const select = $("#csvSelect");
    select.empty();
    files.forEach(f => {
      const opt = $("<option>").val(f).text(f);
      if (f === selectedCsvFile) opt.attr("selected", true);
      select.append(opt);
    });
  });
}

$("#csvSelect").on("change", function() {
  selectedCsvFile = this.value;
  updatePlotImage();
});




function updateState() {
  $.getJSON("/state", function(data) {
    const html = `
      <p><b>–ë–∞–ª–∞–Ω—Å:</b> ${data.balance}</p>
      <p><b>–û—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏:</b> ${data.position}</p>
      <p><b>–ü–æ—Å–ª–µ–¥–Ω–∏–π —Å–∏–≥–Ω–∞–ª:</b> ${data.signal == 1 ? "–ö—É–ø–∏—Ç—å" : data.signal == -1 ? "–ü—Ä–æ–¥–∞—Ç—å" : "–ù–µ—Ç —Å–∏–≥–Ω–∞–ª–∞"}</p>
      <p><b>–ü–æ—Å–ª–µ–¥–Ω—è—è —Å–¥–µ–ª–∫–∞:</b> ${data.last_trade?.action || "-"}, –¶–µ–Ω–∞: ${data.last_trade?.price || "-"}, –î–∞—Ç–∞: ${data.last_trade?.date || "-"}</p>
    `;
    $("#statePanel").html(html);
  });
}

function updateLog() {
  if (currentLog) {
    loadLog(currentLog);
  }
}
let currentLog = null;

function updateLogList() {
  $.get("/logs", function(files) {
    const select = $("#logSelect");
    select.empty();
    files.forEach(f => {
      select.append(`<option value="${f}">${f}</option>`);
    });
    if (files.length > 0) {
      currentLog = files[0];
      select.val(currentLog);
      loadLog(currentLog);
    }
  });
}

function loadLog(filename) {
  $.get(`/log/${filename}`, function(data) {
    $("#logBox").text(data);
  });
}

$("#logSelect").on("change", function() {
  currentLog = this.value;
  loadLog(currentLog);
});





function updateTrades() {
  $.get("/candles", function(data) {
    const rows = data.trim().split("\n").slice(1);
    const tbody = $("#tradeTable tbody");
    tbody.empty();
    rows.forEach(r => {
      const cols = r.split(",");
      const ord = parseInt(cols[6]);
      if (ord !== 0) {
        tbody.append(`<tr><td>${cols[0]}</td><td>${ord > 0 ? "–ö—É–ø–ª–µ–Ω–æ" : "–ü—Ä–æ–¥–∞–Ω–æ"}</td><td>${cols[4]}</td></tr>`);
      }
    });
  });
}

setInterval(() => {
  updateChart();
  updateLog();
  updateTrades();
  updateLogList();
  updatePlotImage();
}, 10000);
updateChart(); updateLog(); updateTrades(); updateLogList(); loadCsvList(); updatePlotImage(); 
</script>
</body>
</html>
